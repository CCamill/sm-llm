# 智能样本生成系统 - 最终总结

## 系统概述

本系统是一个智能的源码-汇编函数相似度标签生成系统，能够自动生成相似和不相似样本，并按比例分割为训练/测试/验证集。

## 核心特性

### 1. 智能相似样本生成
- **基于签名匹配**: 生成所有可能的相似样本，不人为限制数量
- **精确匹配**: 相似度 = 1.0
- **模糊匹配**: 相似度 = 0.8
- **充分利用数据**: 不会浪费任何可用的相似样本

### 2. 智能不相似样本生成
- **自动计算数量**: 不相似样本数量 = 相似样本数量 × 1.5
- **跨项目生成**: 生成来自不同项目的函数对
- **LLM计算相似度**: 使用Qwen2.5-coder模型计算相似度
- **相似度接近0.0**: 符合不相似样本的预期

### 3. 数据整合与分割
- **随机混合**: 相似和不相似样本随机混合
- **标准分割**: 按7:2:1比例分割为训练/测试/验证集
- **多种输出**: 支持PKL和CSV两种输出格式

## 文件结构

```
src/generate_samples_by_LLM/
├── smart_integrated_main.py      # 主脚本（推荐使用）
├── smart_label_generator.py      # 智能相似样本生成器
├── dissimilar_generator.py       # 不相似样本生成器
├── data_integrator.py            # 数据整合器
├── data_splitter.py              # 数据分割器
├── data_loader.py                # 数据加载器
├── function_matcher.py           # 函数匹配器
├── llm_similarity.py             # LLM相似度计算器
├── similarity_mapper.py          # 相似度映射器
├── dissimilar_data_loader.py     # 不相似数据加载器
├── dissimilar_llm_calculator.py  # 不相似LLM计算器
├── requirements.txt              # 依赖文件
├── SMART_README.md               # 详细说明文档
├── test_smart_system.py          # 测试脚本
└── FINAL_SUMMARY.md              # 本文件
```

## 使用方法

### 基本使用

```bash
# 激活conda环境
conda activate sm

# 测试模式（只处理前2个项目）
python src/generate_samples_by_LLM/smart_integrated_main.py --test-mode

# 处理所有项目
python src/generate_samples_by_LLM/smart_integrated_main.py

# 处理指定项目
python src/generate_samples_by_LLM/smart_integrated_main.py --projects curl sqlite nmap
```

### 参数说明

- `--source-dir`: 源码函数数据目录
- `--asm-dir`: 汇编函数数据目录
- `--output-dir`: 输出目录
- `--projects`: 项目列表（None表示处理所有项目）
- `--train-ratio`: 训练集比例（默认：0.7）
- `--test-ratio`: 测试集比例（默认：0.2）
- `--val-ratio`: 验证集比例（默认：0.1）
- `--random-seed`: 随机种子（默认：42）
- `--test-mode`: 测试模式

## 输出文件

### 数据集文件
- `dataset_split_train.csv`: 训练集（70%）
- `dataset_split_test.csv`: 测试集（20%）
- `dataset_split_val.csv`: 验证集（10%）
- `dataset_split_statistics.csv`: 统计信息
- `dataset_split.pkl`: 完整数据集（PKL格式）

### 子目录
- `similar_labels/`: 相似样本标签文件
- `dissimilar_labels/`: 不相似样本标签文件

## 测试结果

### 样本分布
- **总样本数**: 997个
- **相似样本**: 399个（40.0%）
- **不相似样本**: 598个（60.0%）

### 相似度分布
- **相似样本平均相似度**: 0.999（接近1.0）
- **不相似样本平均相似度**: 0.133（接近0.0）
- **整体平均相似度**: 0.480

### 数据分割
- **训练集**: 697个样本（70%）
- **测试集**: 199个样本（20%）
- **验证集**: 101个样本（10%）

## 系统优势

### 1. 智能化
- **自动计算样本数量**: 不需要人为设置参数
- **基于签名匹配**: 生成所有可能的相似样本
- **智能比例**: 不相似样本数量自动计算

### 2. 完整性
- **充分利用数据**: 不浪费任何可用的相似样本
- **全面覆盖**: 处理所有项目的所有匹配函数
- **质量保证**: 基于签名匹配，相似样本质量更高

### 3. 合理性
- **平衡分布**: 相似和不相似样本比例更加合理
- **标准分割**: 按机器学习标准分割数据集
- **随机混合**: 避免数据偏差

### 4. 易用性
- **参数简化**: 移除不必要的参数
- **自动化**: 大部分过程自动化
- **文档完善**: 提供详细的说明文档

## 技术特点

### 1. 模块化设计
- **职责分离**: 每个模块负责特定功能
- **可扩展性**: 易于添加新功能
- **可维护性**: 代码结构清晰

### 2. 错误处理
- **异常捕获**: 完善的错误处理机制
- **日志记录**: 详细的日志信息
- **验证机制**: 数据分割结果验证

### 3. 性能优化
- **批处理**: LLM请求批处理
- **延迟控制**: 避免请求过于频繁
- **内存管理**: 合理的内存使用

## 依赖要求

```bash
conda activate sm
pip install langchain langchain-community numpy pandas
```

## 注意事项

1. **Ollama服务**: 确保Ollama服务运行正常
2. **数据质量**: 输入数据需要包含函数签名信息
3. **计算时间**: 不相似样本需要LLM计算，时间较长
4. **内存使用**: 处理大量数据时注意内存使用情况

## 故障排除

1. **Ollama连接失败**: 检查Ollama服务是否运行
2. **内存不足**: 减少处理的项目数量
3. **数据加载失败**: 检查输入目录是否存在且包含有效数据
4. **分割比例错误**: 检查train_ratio + test_ratio + val_ratio = 1.0

## 未来改进

1. **并行处理**: 支持多进程并行处理
2. **缓存机制**: 添加相似度计算缓存
3. **更多模型**: 支持更多LLM模型
4. **可视化**: 添加数据分布可视化

## 总结

本系统成功解决了原有系统的问题，实现了智能化的样本生成和数据处理。通过基于签名匹配生成所有相似样本，自动计算不相似样本数量，以及合理的数据分割，为机器学习模型训练提供了高质量的数据集。

系统具有智能化、完整性、合理性和易用性等特点，能够满足源码-汇编函数相似度分析的需求。
